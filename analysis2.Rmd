---
title: "Household PM2.5 concentrations in rural and urban households in Peru"
author: "Josiah Kephart"
date: "October 18, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
###Introduction

Peru, along with other low and middle-income countries (LMICs) is experience a transition in the burden of disease from infectious diseases to chronic diseases. Air pollution, both ambient and indoor, is a major risk factor for chronic disease of the lungs and heart. Air pollution is known to vary by geography due to differences in both regional development and household behaviors. Characterizing the airborne exposures faced by Peruvians in both urban and rural areas is critical to understanding the contribution of air pollution to rising chronic disease and to inform interventions that reduce exposures.  

While remote sensing and ambient measurements can be used to model ambient air pollution, less is known about indoor, household air pollution in Peru. Because many people spend the majority of their times indoors, understanding household air pollution (HAP) is critically needed to assess total air pollution exposure and the connections between air pollution exposure and chronic disease.  

###Methods

####Data Collection  

To accomplish this aim, a study of household air pollution and clinical outcomes, known as CRONICAS, was conducted in Lima and Puno, Peru in 2014-2015. Using a personal DataRAM (PdR) monitor, PM2.5 was measured for 48 hours at one-minute temporal resolution in roughly 336 households in Lima (urban) and 357 households in Puno (rural).  

####Exploratory Analysis

Various plots and graphs were used to perform exploratory data analysis. PM levels were alternately transformed to a log10 scale to assist in visualization and comparison across geographic groups. 

####Reproducibility

To provide reproducibility, all analyses were recorded in a R markdown file. Data has been provided in a zipped folder. 

####Results

All data were initially provided in one-minute temporal resolution and were summarized by household and hour for this analysis.




```{r urban, include = FALSE}

library(data.table)
library(dplyr)
library(plyr)
library(stringi)
library(ggplot2)

#setwd("C:/Users/josia/Google Drive/Research/CRONICAS")
setwd(".././Data/Urban/MedicionesUrbano/MedicionesUrbano/PDR URBANO/Data")

urban_samples <- list.files(path = ".", pattern = ".CSV")

##Add household ID to data
read_csv_filename <- function(urban_samples){
  ret <- fread(urban_samples, showProgress = T, autostart = 15)
  ret$Source <- urban_samples 
  ret
}

samples_urban <- ldply(urban_samples, read_csv_filename) 


##Clean up columns

urbandata <- samples_urban
urbandata$pmurban <- rowSums(urbandata[,c("Avg.(mg/m³)", "Avg.(mg/m3)")], na.rm = T)
urbandata$hid <- stri_sub(urbandata$Source,7,12)
urbandata$yr <- stri_sub(urbandata$Source, 19,20)
urbandata$ndate <- paste(urbandata$Date,urbandata$yr)
urbandata$ndatetime <- paste(urbandata$ndate, urbandata$Time)
urbandata$datetime <- lubridate::dmy_hms(urbandata$ndatetime)
urbandata$hour <- stri_sub(urbandata$Time,1,2)
urbandata$hidtime <- paste(urbandata$hid,urbandata$ndate,urbandata$hour, sep = "_")
urbandata$hiddt <- gsub(" ", "", urbandata$hidtime)
urbandata$strtdate <- stri_sub(urbandata$Source,14,20)
urbandata$sampleid <- paste0(urbandata$hid,urbandata$strtdate)

usamp_u <- length(unique(urbandata$sampleid))
logs_u <- length(urbandata$hiddt)

logs_per_samp_u <- (logs_u)/(usamp_u)
logs_per_samp_u

hrs_per_samp_u <- logs_per_samp_u/60
hrs_per_samp_u



urbandata <- select_(urbandata, "hiddt", "pmurban","strtdate", "hid","datetime")

head(urbandata)

length(urbandata$hiddt)

quant <- "quantile(pmurban, probs=0.95)"
funs <- c("mean", "max", "median",quant)

sumdata_urban <- urbandata %>%
  group_by(hiddt) %>%
  summarise_at(vars(pmurban), funs) %>% 
  mutate(hid = stri_sub(hiddt, 1,6)) %>%
  mutate(hr = stri_sub(hiddt, -2,-1)) 
  
head(sumdata_urban)
  

#create columns in summarized data set 


unihid_urban <- unique(sumdata_urban$hid)
length(urban_samples)
length(unihid_urban)

urbanpm <- sumdata_urban %>%
  summarise(mean = mean(mean)) 
  
urbanpm$median <- sumdata_urban %>%
  summarise(median = mean(median)) 

urbanpm$perc95 <- sumdata_urban %>%
  summarise(perc95 = max(quantile))

urbanpm$sd <- sumdata_urban %>%
  summarise(sd = sd(mean))

```

```{r rural, include=FALSE}

setwd("C:/Users/josia/Google Drive/Research/CRONICAS/Data/Rural/MedicionesRural/MedicionesRural/PDR RURAL/Data")

rural_samples <- list.files(path = ".", pattern = ".CSV")

##Add household ID to data
read_csv_filename <- function(rural_samples){
  ret <- fread(rural_samples, showProgress = T, autostart = 15)
  ret$Source <- rural_samples #EDIT
  ret
}

samples_rural <- ldply(rural_samples, read_csv_filename); 

##Clean up columns

ruraldata <- samples_rural
ruraldata$pmrural <- rowSums(ruraldata[,c("Avg.(mg/m³)", "Avg.(mg/m3)")], na.rm = T)
ruraldata$hid <- stri_sub(ruraldata$Source,7,12)
ruraldata$yr <- stri_sub(ruraldata$Source, 19,20)
ruraldata$ndate <- paste(ruraldata$Date,ruraldata$yr)
ruraldata$ndatetime <- paste(ruraldata$ndate, ruraldata$Time)
ruraldata$datetime <- lubridate::dmy_hms(ruraldata$ndatetime)
ruraldata$hour <- stri_sub(ruraldata$Time,1,2)
ruraldata$hidtime <- paste(ruraldata$hid,ruraldata$ndate,ruraldata$hour, sep = "_")
ruraldata$hiddt <- gsub(" ", "", ruraldata$hidtime)
ruraldata$strtdate <- stri_sub(ruraldata$Source,14,20)
ruraldata <- select_(ruraldata, "hiddt", "pmrural","strtdate", "hid","datetime")
head(ruraldata)

#Create summarized data set by ID & hour

quant <- "quantile(pmrural, probs=0.95)"
funs <- c("mean", "max", "median",quant)

sumdata_rural <- ruraldata %>%
  group_by(hiddt) %>%
  summarise_at(vars(pmrural), funs) %>% 
  mutate(hid = stri_sub(hiddt, 1,6)) %>%
  mutate(hr = stri_sub(hiddt, -2,-1)) 
  
head(sumdata_rural)

#create columns in summarized data set 

unihid_rural <- unique(sumdata_rural$hid)
length(samples_rural)
length(unihid_rural)

ruralpm <- sumdata_rural %>%
  summarise(mean = mean(mean)) 
  
ruralpm$median <- sumdata_rural %>%
  summarise(median = mean(median)) 

ruralpm$perc95 <- sumdata_rural %>%
  summarise(perc95 = max(quantile))

ruralpm$sd <- sumdata_rural %>%
  summarise(sd = sd(mean))

```
#####Sample size

Urban samples: 336

Rural samples: 357

#####Summary statistics of hourly PM concentrations
**Urban PM2.5**

```{r summarystats, echo=FALSE}
urbanpm

```
**Rural PM2.5**
```{r summarystats2, echo=FALSE}
ruralpm
```


```{r plotsmean, echo=FALSE}
hrurban <- sumdata_urban %>%
  group_by(hr) %>%
  summarise_at(vars(median),mean)

hrrural <- sumdata_rural %>%
  group_by(hr) %>%
  summarise_at(vars(median),mean)

#Plot mean hourly household median

urbanmeanbase <- ggplot() + 
  geom_line(data = hrurban, aes(hr,median, group = 1, color = "Urban households"), colour = 4) +
  ylab("Median PM2.5 mg/m3") + 
  xlab("Daily Hour") + 
  geom_hline(yintercept = 0.012) +   
  ggtitle("Mean hourly median PM2.5 concentrations in urban households") 
```

```{r ploturbanmean, echo=FALSE}
urbanmeanbase
```

```{r save1, echo=FALSE}
ggsave("./urbanmean.jpg", plot=last_plot())
```

```{r plotsmedian2, echo=FALSE}
urbanmeanbase + geom_line(data = hrrural, aes(hr,median, group = 1, color = "Rural households")) +
  ggtitle("Mean hourly median PM2.5 concentrations in urban and rural households") 
ggsave("./bothmean.jpg", plot=last_plot())
```

```{r plotsmedian3, echo=FALSE}

#Create log10 scaled graph

log10ug_urb <- hrurban %>%
  mutate(log10urban = log10(median*1000)) %>%
  select(log10urban, hr)

log10ug_rur <- hrrural %>%
  mutate(log10rural = log10(median*1000)) %>%
  select(log10rural, hr)

logurb_base <- ggplot() + 
  geom_line(data = log10ug_urb, aes(hr,log10urban, group = 1, color = "Urban households"), colour = 4) +
  ylab("Log10 PM2.5 ug/m3") + 
  xlab("Daily Hour") + 
  geom_hline(yintercept = log10(0.012*1000), col="black") +   
  ggtitle("Mean hourly median PM2.5 concentrations in urban households") 
logurb_base

ggsave("./logurbanmean.jpg", plot=last_plot())
```

```{r plotsmedian4, echo=FALSE}
logurb_base + geom_line(data = log10ug_rur, aes(hr,log10rural, group = 1, color = "Rural households")) +
  ggtitle("Mean hourly median PM2.5 concentrations in urban and rural households") 
ggsave("./logbothmean.jpg", plot=last_plot())

```

```{r boxplots, echo=FALSE}

#urban box plots

sumdata_urban_n <- sumdata_urban %>%
  mutate(hr_num = as.numeric(hr))

#jpeg('urbanbox.jpg')
boxplot(median ~ hr, data=sumdata_urban_n, main="Median hourly PM2.5 in urban households", xlab="Hour of day",ylab="PM2.5 mg/m3", col="blue")
abline(h=0.012, col="green")
dev.copy(jpeg,'urbanbox.jpg')
dev.off()

#rural box plots

sumdata_rural_n <- sumdata_rural %>%
  mutate(hr_num = as.numeric(hr))

boxplot(median ~ hr, data=sumdata_rural_n, main="Median hourly PM2.5 in rural households", xlab="Hour of day",ylab="PM2.5 mg/m3")
abline(h=0.012, col="green")
dev.copy(jpeg,'ruralbox.jpg')
dev.off()

#urban log10

sumdata_urban_log <- sumdata_urban %>%
  mutate(logurban = log10(median*1000+1))

boxplot(logurban ~ hr, data=sumdata_urban_log, main="Median hourly PM2.5 in urban households", xlab="Hour of day",ylab="Log10 PM2.5 ug/m3")
abline(h=log10(0.012*1000), col="green")
dev.copy(jpeg,'logurbanbox.jpg')
dev.off()


#rural log10

sumdata_rural_log <- sumdata_rural %>%
  mutate(logrural = log10(median*1000+1))

boxplot(logrural ~ hr, data=sumdata_rural_log, main="Median hourly PM2.5 in rural households", xlab="Hour of day",ylab="Log10 PM2.5 ug/m3")
abline(h=log10(0.012*1000), col="green")
dev.copy(jpeg,'logruralbox.jpg')
dev.off()


```

####Conclusions